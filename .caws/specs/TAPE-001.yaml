id: TAPE-001
type: feature
title: >-
  Tape Writer Hot-Path Optimization: eliminate avoidable work during search
  recording
status: in_progress
risk_tier: 2
mode: development
created_at: '2026-02-27T03:03:20.350Z'
updated_at: '2026-02-27T03:03:20.351Z'
blast_radius:
  modules:
    - search/tape
    - search/search
    - benchmarks
  data_migration: false
operational_rollback_slo: 5m
scope:
  in:
    - search/src/tape.rs
    - search/src/tape_writer.rs
    - search/src/search.rs
    - harness/src/runner.rs  # lint allow on ScorerInputV1 (ContentHash size consequence)
    - benchmarks/
    - .caws/specs/TAPE-001.yaml
  out:
    - kernel/
    - search/src/node.rs
    - search/src/frontier.rs
    - search/src/graph.rs
    - search/src/contract.rs
    - harness/src/bundle.rs
    - harness/src/bundle_dir.rs
    - tests/lock/
    - docs/
    - ml/
scope_overlaps:
  - spec: SPINE-001
    files:
      - harness/src/runner.rs  # SPINE-001 includes harness/; TAPE-001 only added lint allow
    reason: >-
      TAPE-001 added #[allow(clippy::large_enum_variant)] on ScorerInputV1 in
      e8b1844. This remains necessary after the ContentHash cache revert because
      clippy still flags the Table variant size. The change is a single-line lint
      annotation that does not alter SPINE-001 harness semantics.
threats:
  - "Tape-only invariants gating the non-tape search path (coupling footgun)"
  - "Pre-sizing buffer from untrusted policy values causing OOM"
  - "Struct bloat in ubiquitous types (ContentHash) causing cache pressure regression — measured and reverted"
invariants:
  - "INV-TO-01: Tape recording is optional; search without tape must not fail due to tape-only invariants"
  - "INV-TO-03: TapeWriteError variants are tape-local; no kernel error types exposed in search public API"
  - "INV-TO-04: Scratch buffer provides transactional atomicity: if body construction fails, buf is untouched"
  - "INV-TO-05: Pre-allocation is clamped to 256 MB regardless of policy input"
acceptance:
  - id: TO1-NO-TAPE-NO-FAIL
    given: "search() called without tape (tape_sink is None)"
    when: "search completes"
    then: "no tape-related errors; search_fn_total within ±3% of pre-TAPE-001 baseline"
  - id: TO1-SCRATCH-ATOMICITY
    given: "TapeWriter with scratch buffer"
    when: "body construction fails (e.g., OpArgsTooLong)"
    then: "self.buf is unchanged from before the on_* call"
  - id: TO1-ERROR-LAYERING
    given: "TapeWriteError enum"
    when: "inspected for kernel type dependencies"
    then: "no kernel error types; content_hash_to_raw maps to tape-local InvalidHexDigest/UnsupportedHashAlgorithm"
  - id: TO1-PREALLOC-CAP
    given: "policy with max_expansions=u64::MAX"
    when: "estimate_tape_capacity() is called"
    then: "returns fallback (4096), not OOM"
  - id: TO1-SHORT-DIGEST-REJECTION
    given: "a ContentHash with sha256 algorithm but short hex digest"
    when: "content_hash_to_raw() is called"
    then: "returns TapeWriteError::InvalidHexDigest"
non_functional:
  performance: "No regression on search_fn_total; tape overhead reduced ~5% via scratch buffer + prealloc"
  security: "Pre-allocation clamped to 256 MB; no untrusted-size allocations"
  accessibility: "N/A (internal optimization, no UI)"
contracts:
  - type: project_setup
    path: .caws/specs/TAPE-001.yaml
    description: "Internal perf optimization; no external API contracts. Invariants defined in spec."
reverted:
  - change: "ContentHash raw_sha256 cache (Option<[u8;32]>)"
    reason: >-
      Struct bloat (~40→72 bytes) caused 18-23% regression in search_fn_total at
      scale_1000 via cache pressure on SearchNodeV1/CandidateActionV1. Reverted in
      commit df0b25b. Three-point A/B/C bisect confirmed the cache was the sole
      cause. Scratch buffer + prealloc retained as regression-free wins.
    commits:
      - "69ceca3 (added, tagged [SPINE-001] [SEARCH-CORE-001])"
      - "df0b25b (reverted, tagged [TAPE-001] only — should also carry [SPINE-001] per convention since it touches kernel/)"
change_budget:
  max_files: 8
  max_loc: 300
